```sql


create table public.service_images (
  id bigint generated by default as identity not null,
  service_id uuid not null,
  path text not null,
  path_thumbnail text null,
  "primary" boolean null default false,
  created_at timestamp with time zone not null default now(),
  constraint service_images_pkey primary key (id),
  constraint service_id_fkey foreign KEY (service_id) references services (id)
) TABLESPACE pg_default;

-----trigger para actualizar las tablas cuando se sube una imagen al bucket-------------
create or replace function public.handle_service_image_upload()
returns trigger
language plpgsql
security definer
as $$
declare
  v_service_id uuid;
  v_thumb_path text;
begin
  -- Solo bucket correcto
  if new.bucket_id <> 'service_images' then
    return new;
  end if;

  -- Extraer metadata
  v_service_id := (new.user_metadata ->> 'service_id')::uuid;

  if v_service_id is null then
    return new;
  end if;


  -- CASO IMAGEN NORMAL
  v_thumb_path := replace(new.name, 'full_', 'thumb_');

  insert into public.service_images (
    service_id,
    path,
    path_thumbnail
  )
  values (
    v_service_id,
    new.name,
    v_thumb_path
  );

  return new;
end;
$$;


-- trigger cuando se sube una imagen 
DROP TRIGGER IF EXISTS on_service_image_uploaded ON storage.objects;

create trigger on_service_image_uploaded
after insert on storage.objects
for each row
execute function public.handle_service_image_upload();


-----trigger para actualizar las tablas cuando se elimina una imagen del bucket---------------------

create or replace function public.handle_service_image_delete()
returns trigger
language plpgsql
security definer
as $$
declare
  v_thumb_path text;
begin
  if old.bucket_id <> 'service_images' then
    return old;
  end if;

  -- CASO THUMBNAIL
  if old.name like '%/thumb_%' then
    update public.service_images
    set path_thumbnail = null
    where path_thumbnail = old.name;

    return old;
  end if;

  -- CASO IMAGEN FULL
  if old.name like '%/full_%' then
    select path_thumbnail
    into v_thumb_path
    from public.service_images
    where path = old.name;

    -- borrar thumbnail asociado
    if v_thumb_path is not null then
      delete from storage.objects
      where bucket_id = old.bucket_id
        and name = v_thumb_path;
    end if;

    delete from public.service_images
    where path = old.name;

    return old;
  end if;

  return old;
end;
$$;


create trigger on_service_image_deleted
after delete on storage.objects
for each row
execute function public.handle_service_image_delete();

--------------------------------------------------------

  
ALTER TABLE public.service_images ENABLE ROW LEVEL SECURITY;

create policy "services can read images"
on public.service_images
for select
using (true);

-- UPDATE primary
create policy "services can update primary image"
on public.service_images
for update
using (true)
with check (true);

```
