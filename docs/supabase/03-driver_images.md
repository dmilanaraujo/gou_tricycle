```sql


create table public.driver_images (
  id bigint generated by default as identity not null,
  driver_id uuid not null,
  path text not null,
  path_thumbnail text null,
  created_at timestamp with time zone not null default now(),
  "primary" boolean null default false,
  constraint driver_images_pkey primary key (id),
  constraint driver_id_fkey foreign KEY (driver_id) references drivers (id)
) TABLESPACE pg_default;


create or replace function public.handle_driver_image_upload()
returns trigger
language plpgsql
security definer
as $$
    declare
      v_driver_id uuid;
      v_thumb_path text;
    begin

      if new.bucket_id <> 'driver_images' then
        return new;
      end if;
    
      -- Extraer driver_id de la metadata
      v_driver_id := (new.user_metadata ->> 'driver_id')::uuid;
    
      -- Si no viene el driver_id no seguir 
      if v_driver_id is null then
        return new;
      end if;
    
      v_thumb_path := replace(new.name, 'full_', 'thumb_');
      
      insert into public.driver_images (
        driver_id,
        path,
        path_thumbnail
      )
      values (
        v_driver_id,
        new.name,
        v_thumb_path
      );
    
      return new;
    end;
$$;

-- trigger cuando se sube una imagen 
DROP TRIGGER IF EXISTS on_driver_image_uploaded ON storage.objects;

create trigger on_driver_image_uploaded
after insert on storage.objects
for each row
execute function public.handle_driver_image_upload();


------------------------------------------------

create or replace function public.handle_driver_image_delete()
returns trigger
language plpgsql
security definer
as $$
declare
  v_thumb_path text;
begin
  -- Solo actuar sobre el bucket correcto
  if old.bucket_id <> 'driver_images' then
    return old;
  end if;

  -- CASO 1: se elimina un thumbnail
  if old.name like '%/thumb_%' then
    update public.driver_images
    set path_thumbnail = null
    where path_thumbnail = old.name;

    return old;
  end if;

  -- CASO 2: se elimina una imagen full
  if old.name like '%/full_%' then
    -- obtener el thumbnail asociado
    select path_thumbnail
    into v_thumb_path
    from public.driver_images
    where path = old.name;

    -- borrar thumbnail del storage (si existe)
    if v_thumb_path is not null then
      delete from storage.objects
      where bucket_id = old.bucket_id
        and name = v_thumb_path;
    end if;

    -- borrar el row completo
    delete from public.driver_images
    where path = old.name;

    return old;
  end if;

  return old;
end;
$$;

create trigger on_driver_image_deleted
after delete on storage.objects
for each row
execute function public.handle_driver_image_delete();

--------------------------------------------------------

  
ALTER TABLE public.driver_images ENABLE ROW LEVEL SECURITY;

create policy "drivers can read images"
on public.driver_images
for select
using (true);

-- UPDATE primary
create policy "drivers can update primary image"
on public.driver_images
for update
using (auth.uid() = driver_id)
with check (auth.uid() = driver_id);

```
